<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ¥” ê°ì ë†ì¥ - Potato Farm</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Do Hyeon', sans-serif;
      height: 100%;
    }
    body {
      background: url('https://byungil-cho.github.io/OrcaX/farm-101.png') no-repeat center top fixed;
      background-size: cover;
      overflow: auto;
    }
    .scroll-area {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      padding-bottom: 3rem;
      box-sizing: border-box;
    }
    header {
      padding: 1rem;
      font-size: 2rem;
      color: #ffffff;
      text-shadow: 1px 1px 2px #000;
      text-align: center;
    }
    .nickname, .info-bar {
      margin-top: 0.5rem;
      font-size: 1.1rem;
      color: #ffffff;
      text-shadow: 1px 1px 2px #000;
      text-align: center;
    }
    .info-bar { font-size: 0.95rem; }
    .potato-field, .storage-section, .product-section, .nav-buttons {
      margin: 1rem;
      padding: 1rem;
      background: rgba(255,255,255,0.8);
      border-radius: 1rem;
    }
    .potato-btns button {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.75rem;
      background: #a5d6a7;
      cursor: pointer;
    }
    .storage-section ul, .product-section ul {
      list-style: none;
      padding: 0;
    }
    .storage-section li, .product-section li {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    .nav-buttons a {
      display: inline-block;
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: #4caf50;
      color: white;
      text-decoration: none;
      border-radius: 0.5rem;
    }
    .server-status {
      text-align: center;
      margin-top: 1rem;
      font-weight: bold;
      color: #fff700;
    }
  </style>
</head>
<body>
  <div class="scroll-area">
    <header>ê°ì ë†ì¥</header>
    <div class="nickname">ë†ì¥ì£¼: <span id="nickname">ë¡œë”© ì¤‘...</span></div>
    <div class="info-bar">ë†ì¥ì´ë¦„: <span id="farmName">ë¡œë”© ì¤‘...</span></div>
    <div class="server-status" id="serverStatus">ğŸ”Œ ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘...</div>

    <div class="potato-field">
      <h2>ğŸŒ¾ ë†ì‚¬ ëª©ë¡</h2>
      <div class="potato-btns">
        <button onclick="startFarming()">ğŸ¥” ìˆ˜í™•í•˜ê¸°</button>
        <button onclick="applyWater()">ğŸ’§ ë¬¼ ì£¼ê¸°</button>
        <button onclick="applyFertilizer()">ğŸŒ¿ ê±°ë¦„ ì£¼ê¸°</button>
      </div>
    </div>

    <div class="storage-section">
      <h2>ğŸ“¦ ìì¬ ë³´ê´€í•¨</h2>
      <ul id="storage-list"></ul>
    </div>

    <div class="product-section">
      <h2>ğŸŸ ë†ì‚°ë¬¼ ë³´ê´€í•¨</h2>
      <ul id="product-list"></ul>
    </div>

    <div class="nav-buttons">
      <a href="gamja-result.html">ê°ì ê°€ê³µê³µì¥</a>
      <a href="gamja-main.html">ë³µê·€</a>
    </div>
  </div>

  <script>
    const API_BASE = "https://climbing-wholly-grouper.jp.ngrok.io";

    async function fetchUserData() {
      try {
        const nicknameRaw = localStorage.getItem("nickname") || " ";
        const farmName = localStorage.getItem("farmName") || "ë†ì¥ì£¼";
        document.getElementById("nickname").textContent = nicknameRaw;
        document.getElementById("farmName").textContent = farmName;

        const encodedNickname = encodeURIComponent(nicknameRaw);
        const res = await fetch(`${API_BASE}/api/userdata?nickname=${encodedNickname}`);
        const data = await res.json();
        const user = data.users[0];
        const growthPoint = user.growthPoint || 0;
        const growthInfo = document.createElement("div");
        growthInfo.style.textAlign = "center";
        growthInfo.style.marginTop = "0.5rem";
        growthInfo.style.fontWeight = "bold";
        growthInfo.innerText = `ğŸŒ± ì„±ì¥ í¬ì¸íŠ¸: ${growthPoint}`;
        document.querySelector(".potato-field").appendChild(growthInfo);

        const storageList = document.getElementById("storage-list");
        storageList.innerHTML = "";
        const ìì¬ë“¤ = [
          { label: "ì”¨ê°ì", value: user.seedPotato },
          { label: "ì”¨ë³´ë¦¬", value: user.seedBarley },
          { label: "ë¬¼", value: user.water },
          { label: "ê±°ë¦„", value: user.fertilizer },
          { label: "ORCX", value: user.orcx }
        ];
        ìì¬ë“¤.forEach(item => {
          const li = document.createElement("li");
          li.textContent = `${item.label}: ${item.value}`;
          storageList.appendChild(li);
        });

        const productList = document.getElementById("product-list");
        productList.innerHTML = "";
        user.inventory.forEach(item => {
          const type = item.type || item.name || "ì •ì˜ë˜ì§€ ì•ŠìŒ";
          const li = document.createElement("li");
          li.textContent = `${type}: ${item.count}`;
          productList.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        alert("âŒ ìœ ì € ì •ë³´ ë¡œë”© ì‹¤íŒ¨");
      }
    }

    async function startFarming() {
      try {
        const nickname = localStorage.getItem("nickname") || " ";
        const encodedNickname = encodeURIComponent(nickname);
        const resUser = await fetch(`${API_BASE}/api/userdata?nickname=${encodedNickname}`);
        const userData = await resUser.json();
        const user = userData.users[0];
        const growthPoint = user.growthPoint || 0;
        const seedPotato = user.seedPotato || 0;

        if (growthPoint < 5) {
          alert("âŒ ì„±ì¥ í¬ì¸íŠ¸ê°€ 5 ì´ìƒì´ì–´ì•¼ ìˆ˜í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }

        if (seedPotato < 1) {
          alert("âŒ ì”¨ê°ìê°€ ë¶€ì¡±í•˜ì—¬ ë†ì‚¬ë¥¼ ì§€ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const harvestCount = [3, 5, 7][Math.floor(Math.random() * 3)];
        const res = await fetch(`${API_BASE}/api/farm/harvest`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname: encodedNickname, amount: harvestCount })
        });
        const result = await res.json();
        alert(`ğŸ¥” ê°ì ${harvestCount}ê°œ ìˆ˜í™• ì™„ë£Œ!`);
        fetchUserData();
      } catch (err) {
        console.error(err);
        alert("âŒ ìˆ˜í™• ì‹¤íŒ¨");
      }
    }

    async function applyWater() {
      try {
        const nickname = localStorage.getItem("nickname") || " ";
        const encodedNickname = encodeURIComponent(nickname);

        const res = await fetch(`${API_BASE}/api/farm/grow`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname: encodedNickname, cropType: "gamja" })
        });

        const result = await res.json();
        if (result.success) {
          alert("ğŸ’§ ë¬¼ê³¼ ê±°ë¦„ì„ ì£¼ì—ˆìŠµë‹ˆë‹¤. ì„±ì¥ í¬ì¸íŠ¸ +1!");
          fetchUserData();
        } else {
          alert("âŒ ë¬¼ì£¼ê¸° ì‹¤íŒ¨: " + result.error);
        }
      } catch (err) {
        console.error(err);
        alert("âŒ ë¬¼ ì£¼ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }

    async function applyFertilizer() {
      try {
        const nickname = localStorage.getItem("nickname") || " ";
        const encodedNickname = encodeURIComponent(nickname);

        const res = await fetch(`${API_BASE}/api/farm/grow`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname: encodedNickname, cropType: "gamja" })
        });

        const result = await res.json();
        if (result.success) {
          alert("ğŸŒ¿ ê±°ë¦„ê³¼ ë¬¼ì„ ì£¼ì—ˆìŠµë‹ˆë‹¤. ì„±ì¥ í¬ì¸íŠ¸ +1!");
          fetchUserData();
        } else {
          alert("âŒ ê±°ë¦„ ì£¼ê¸° ì‹¤íŒ¨: " + result.error);
        }
      } catch (err) {
        console.error(err);
        alert("âŒ ê±°ë¦„ ì£¼ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }

    async function checkServerStatus() {
      try {
        const res = await fetch(`${API_BASE}/`);
        if (res.ok) {
          document.getElementById("serverStatus").textContent = "âœ… ì„œë²„ ì „ì› ON";
        } else {
          throw new Error();
        }
      } catch {
        document.getElementById("serverStatus").textContent = "âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
      }
    }

    checkServerStatus();
    fetchUserData();
  </script>
</body>
</html>
