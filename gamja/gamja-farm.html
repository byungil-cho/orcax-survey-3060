<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê°ì ë†ì¥ ì…ì¥</title>
  <style>
    body {
      font-family: "Pretendard", sans-serif;
      margin: 0;
      padding: 0;
      background: url('https://byungil-cho.github.io/OrcaX/farm-101.png') no-repeat center center fixed;
      background-size: cover;
      color: white;
      text-align: center;
    }
    .container {
      background-color: rgba(0, 0, 0, 0.5);
      margin-top: 5%;
      padding: 20px;
      display: inline-block;
      border-radius: 12px;
    }
    .btn {
      margin-top: 20px;
      padding: 15px 30px;
      background-color: #FFD700;
      color: black;
      font-size: 1.2rem;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .status {
      margin-top: 20px;
      color: #00FF00;
      font-weight: bold;
    }
    .info-box {
      background-color: #2166d1;
      padding: 8px;
      margin: 6px;
      border-radius: 6px;
      text-align: left;
    }
  </style>
  <script>
    'use strict';
    const API_BASE = "https://climbing-wholly-grouper.jp.ngrok.io";
  </script>
</head>
<body>
  <div class="container" role="region" aria-label="ê°ì ë†ì¥ ëŒ€ì‹œë³´ë“œ">
    <h1>ğŸ¥” ê°ì ë†ì¥ì— ì˜¤ì‹  ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!</h1>
    <div class="info-box">ğŸ‘¤ ë‹‰ë„¤ì„: <span id="nickname">-</span></div>
    <div class="info-box">ğŸ¥” ê°ì: <span id="potato">0</span> ê°œ</div>
    <div class="info-box">ğŸ’§ ë¬¼: <span id="water">0</span> ê°œ</div>
    <div class="info-box">ğŸŒ± ê±°ë¦„: <span id="fertilizer">0</span> ê°œ</div>
    <div class="info-box">ğŸª™ ORCX: <span id="token">0</span> ê°œ</div>
    <div class="info-box">ğŸ¥” ì”¨ê°ì: <span id="seedPotato">0</span> ê°œ</div>
    <div class="info-box">ğŸŒ¾ ì”¨ë³´ë¦¬: <span id="seedBarley">0</span> ê°œ</div>
    <div class="info-box">ğŸ§º ì¸ë²¤í† ë¦¬:</div>
    <div id="inventoryBox" class="info-box"></div>
    <div class="status" id="serverStatus" aria-live="polite">â³ ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘...</div>
    <button id="startBtn" class="btn" disabled>ğŸŒ± ë†ì¥ì´ë¦„ ì§“ê¸° ì´ë™</button>
  </div>
  <script type="module">
    (async () => {
      const nicknameValue = localStorage.getItem("nickname");
      if (!nicknameValue) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = 'gamja-login.html';
        return;
      }
      document.getElementById("nickname").textContent = nicknameValue;

      const startBtn = document.getElementById("startBtn");
      const serverStatus = document.getElementById("serverStatus");
      const inventoryBox = document.getElementById("inventoryBox");
      const potatoEl = document.getElementById("potato");
      const waterEl = document.getElementById("water");
      const fertilizerEl = document.getElementById("fertilizer");
      const tokenEl = document.getElementById("token");
      const seedPotatoEl = document.getElementById("seedPotato");
      const seedBarleyEl = document.getElementById("seedBarley");

      startBtn.addEventListener("click", () => {
        window.location.href = "gamja-main.html";
      });

      async function initUser() {
        serverStatus.textContent = "ìœ ì € ì´ˆê¸°í™” ì¤‘...";
        try {
          await fetch(`${API_BASE}/api/init-user`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            cache: 'no-store',
            body: JSON.stringify({ nickname: nicknameValue })
          });
          await loadUserData();
        } catch (err) {
          console.error("Initialization error:", err);
          serverStatus.textContent = "âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        }
      }

      async function loadUserData() {
        serverStatus.textContent = "ë°ì´í„° ë¡œë”© ì¤‘...";
        try {
          const res = await fetch(
            `${API_BASE}/api/userdata`,
            { cache: 'no-store' }
          );
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const user = data.user || (Array.isArray(data.users) ? data.users[0] : null);
          if (!user) throw new Error('ìœ ì € ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

          // ê¸°ë³¸ ìì› ë° í†µê³„ ì¶œë ¥
          potatoEl.textContent = user.potatoCount ?? user.potato ?? 0;
          waterEl.textContent = user.water ?? 0;
          fertilizerEl.textContent = user.fertilizer ?? 0;

          // ìµœì´ˆ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œ ì§€ê¸‰ ëˆ„ë½ ë³´ì™„:
          // ì²« ë¡œê·¸ì¸ ë•Œë§Œ ORCX(í† í°) 10ê°œ ì§€ê¸‰, ì´í›„ 0ì´ ë˜ì–´ë„ ì¬ì§€ê¸‰í•˜ì§€ ì•ŠìŒ
          const initKey = 'initialTokensGiven';
          let orcxVal = user.orcx ?? user.token ?? 0;
          const hasInit = localStorage.getItem(initKey) === 'true';
          if (orcxVal === 0 && !hasInit) {
            orcxVal = 10;
            localStorage.setItem(initKey, 'true');
          }
          tokenEl.textContent = orcxVal;

          seedPotatoEl.textContent = user.seedPotato ?? 0;
          seedBarleyEl.textContent = user.seedBarley ?? 0;

          // ì¸ë²¤í† ë¦¬ ì•„ì´í…œ í‘œì‹œ
          inventoryBox.innerHTML = "";
          (user.inventory || []).forEach(item => {
            const count = item.count ?? 1;
            const name = item.name || item.type || 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ';
            const div = document.createElement("div");
            div.textContent = `- ${name} (${count}ê°œ)`;
            inventoryBox.appendChild(div);
          });

          serverStatus.textContent = "âœ… ì„œë²„ ì—°ê²° ë° ë°ì´í„° ë¡œë“œ ì™„ë£Œ";
          startBtn.disabled = false;
        } catch (err) {
          console.error("Data fetch error:", err);
          serverStatus.textContent = "âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
        }
      }

      initUser();
    })();
  </script>
</body>
</html>
